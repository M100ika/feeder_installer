# Проект: Feeder
**Версия**: 7.1  
**Автор**: Суйеубаев Максат Жамбылович

**Email**: maxat.suieubayev@gmail.com  

## Введение
Проект "Feeder" является продвинутым решением для сбора и отправки данных с устройства, известного как "Кормушка". Он разработан для эффективного мониторинга и управления процессом кормления животных, используя последние технологии и инновации.

### Основные Особенности Версии 7.1
- **Скачивание и установка одной командой**: Проект теперь можно установить с помощью единственной команды, упрощая начальную настройку и развертывание.
  ```bash
   curl -sSL https://raw.githubusercontent.com/M100ika/feeder_installer/main/install.sh | bash
- **Улучшенный сбор данных**: Версия 7.1 включает в себя новый и усовершенствованный метод сбора весовых данных, значительно повышая точность и надежность измерений.
- **Интеграция с Arduino**: С этой версии система появилась возможность автоматически определить порт Arduino.
- **Интеграция с RFID_READER_USB**: С этой версии система появилась возможность автоматически определить порт rfid_reader_USB.
- **Отключение ведения журнала в config.ini**: Добавлена возможность отключения ведения журнала через настройки в config.ini.
- **Журналы хранятся 1 месяц**: Журналы системы теперь хранятся в течении месяца, обеспечивая оптимальный баланс между историей и использованием дискового пространства.
- **Отдельный журнал ошибок**: Для упрощения отладки и мониторинга в систему добавлен отдельный журнал для записи ошибок.
- **Дополнительные конфигурационные файлы**: Введены новые конфигурационные файлы, расширяющие возможности настройки и кастомизации проекта.
- **Добавление калибровки с помощью RFID меток**: Добавлена дополнительная возможность калибровки коэффициентов с помощью rfid меток
- **Добавление работы считывателя RFID меток через USB**: Есть возможность выбрать тип считывателя (USB/Ethernet)
- **Расширение файла config.ini**: Файл config.ini получил дополнительные редактируемые параметры

Этот проект посвящен созданию удобного и надежного инструмента для фермеров и владельцев животных, стремящихся оптимизировать и автоматизировать процесс кормления. С каждым обновлением мы стремимся расширять возможности "Кормушки", улучшая её функциональность и удобство использования.

## Структрука проекта:
    feeder_installer/
    │
    ├── arduino/                  # Все файлы, относящиеся к коду Arduino
    │   ├── HX711-master.zip      # Библиотека АЦП HX711
    │   └── SerialCallResponse_RPi/  # Папка проекта для Arduino
    │       └──SerialCallResponse_RPi.ino   # Проект Arduino
    │
    ├── feeder_log                # Журналы проекта
    │   ├── feeder.log            # Журнал всех сообщений
    │   └── error_log            
    │       └── errors.log        # Журнал ошибок
    │
    ├── src/                      # Исходный код Python проекта
    │   ├── _adc_data.py          # Модуль для работы с АЦП
    │   ├── _config_manager.py    # Модуль конфигурационных настроек
    │   ├── _feeder_module.py     # Модуль функций кормушки
    │   ├── _headers.py           # Заголовки, общие константы
    │   ├── main_feeder.py        # Основной исполняемый скрипт
    │   └── _sql_database.py      # Взаимодействие с базой данных
    │   └── _chafon_rfid_lib.py   # Модуль считывателя chafon CF-MU904
    │
    ├── tests/                    # Тесты проекта
    │   ├── relay.py              # Тест датчика прерывания луча
    │   ├── rfid_reader_test.py   # Тест модуля считывания rfid меток
    │   ├── test_post.py          # Тест связи с сервером
    │   ├── measure_test          # Папка теста датчика веса
    │       └──...
    │
    ├── config/                   # Конфигурационные файлы
    │   ├── config.ini            # Настройки проекта
    │   └── feeder.service        # Файл сервиса для systemd
    |
    ├── docs/                     # Документация
    │   └── feeder_doc/           # Папка документации кормушки
    │        └── feeder_main.puml # Алгоритм главного файла кормушки  
    │   └── rfid_read/            # Папка документации считывателя
    │        └── rfid_read.puml   # Алгоритм главного файла кормушки  
    │
    ├── scripts/                  # Дополнительные скрипты
    │   └── install.sh            # Скрипт установки
    │
    └── README.md                 # Краткое описание проекта


## Инструкция по запуску проекта:
1. Перед началом работы с данным проектом проверьте и если нужно создайте в распберри папку 'mkdir /pi/home/feeder_v71.'
2. Проверьте и если нужно создайте папки src, feeder_log, config, scripts
3. В случае если устройсво новое необходимо заполнить данные об этом устройсве пройдя по следующей ссылке
https://docs.google.com/spreadsheets/d/1XeYxa0_bUGq_OvfEMQHy445ZObuPY38OtOF7z158Gro/edit#gid=0
4. Заполните файл config.ini, пример в пункте 5
5. Если устройство использовалось ранее возьмите необходимые данные из таблицы по ссылке выше и перенесите данные в файл config.ini. 
    ```ini
    [Parameters]
    model = pcf_fdr_71  # Модель оборудования
    type = Feeder   # Тип устройства, Feeder, Scales
    serial_number = feeder0423v21-1     # Здесь вводим данные из таблицы
    url = https://smart-farm.kz:8502/api/v2/RawFeedings
    median_url = http://194.4.56.86:8501/api/weights
    array_url = https://smart-farm.kz:8502/v2/OneTimeWeighings
    arduino_port = /dev/ttyACM0 # Порт ардуино. Проверить с помощью команды ls /dev/tty* . Варианты: ttyACM0, ttyUSB0 или ttyUSB1
    debug = 1  # Ставим 0 после проведения тестов. 0 - отключает логи кроме error. 

    [Calibration]
    taring_rfid =   # RFID метка для автоматического тарирования. Изменить на нужный
    scaling_rfid =  # RFID метка для автоматической калибровки. Изменить на нужный
    weight = 80     # Эталонный вес для калибровки. Изменить на нужный
    offset = 16766507
    scale = -3358.285714285714

    [DbId]
    id = 30
    version = 7.1

    [Relay]
    sensor_pin = 17  # Пин на распберри для датчика прерывания луча

    [RFID_Reader]
    reader_usb = 0  # Поставить 1 если считыватель RFID меток подключен через USB, 0 если через Ethernet
    reader_port = /dev/ttyUSB0 # Порт считывателя. Проверить с помощью команды ls /dev/tty* . Варианты: ttyACM0, ttyUSB0 или ttyUSB1
    reader_power = 26 # Мощность считывателя
    reader_timeout = 2 # Время выделяемое для поиска метки в секундах.
    reader_buzzer = 1 # 1- Включить/ 0- Отключить звук считывателя. 
    ```
6. Запустите файл main_feeder.py
7. Проведите калибровку следуя инструкциям в выводе терминала
8. После калибровки проведите тестовое взвешивание согласно следующему алгоритму:
- положить в кормушку предмет с известным весом
- закрыть датчик прерывания луча
- поднести rfid метку до звукового сигнала
- убрать предмет или часть предмета с известным весом
- подождать 10 секунд и открыть датчик прерывания луча
9. Проверить на сайте smart-farm.kz:8500 во вкладке /Оборудование/Smart-кормушки/Разовый приём корма/ поступили ли данные. 
10. В случае если данных нет, в проверить:
- фильтр таблицы на сайте smart-farm.kz:8500 во вкладке /Оборудование/Smart-кормушки/Разовый приём корма/
- проверить соединен ли raspberry к сети wi-fi
- прочитать все сообщения терминала и найти решение проблемы самостоятельно либо с помощью одного из монтажников/разработчиков кормушки
11. В случае если данные пришли, с помощью ctrl+c завершить программу
12. Перезагрузить raspberry 
13. После подключения к сети wi-fi проделать шаги из пункта 8
14. Если новые данные пришли на сайт - инсталляция завершена успешно
15. После каждого изменения конфигурации рекомендуется перезагрузка.

## Инструкция по Калибровке Системы Взвешивания
**Настройка Конфигурации**
Перед началом калибровки необходимо настроить файл конфигурации **config.ini**:

**1.Тарирование:**
- taring_rfid: введите RFID номер метки тарирования.

**2. Калибровка Веса:**
- scaling_rfid: введите RFID номер метки калибровки веса.
- weight: укажите вес, на который будет производиться калибровка.

**Процедура Тарирования**
1. Подготовка:
- Убедитесь, что на весах ничего нет и показания весов равны нулю.
2. Выполнение:
- Закройте датчик прерывания луча.
- Считайте метку taring_rfid.
- Через секунду после считывания метки откройте датчик.

**Процедура Калибровки Веса**
1. Подготовка:
- Установите на весах заданный вес, указанный в параметре config.ini/weight.
2. Выполнение:
- Закройте датчик прерывания луча.
- Считайте метку scaling_rfid.
- После считывания метки откройте датчик.
    
**Примечание:** Важно проводить процедуру калибровки в условиях, исключающих внешние воздействия (например, вибрации или движение), которые могут повлиять на точность измерений.
